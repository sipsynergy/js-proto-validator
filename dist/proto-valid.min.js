"use strict";function each(e,n){return(Array.isArray(e)?eachArray:eachObj)(e,n)}function eachArray(e,n){for(var t=0;t<e.length&&!n(e[t],t);++t);return e}function eachObj(e,n){return eachArray(Object.keys(e),function(t){n(e[t],t)})}function get(e,n,t){var r,o=e;return each(n.split("."),function(e){if(void 0===o[e])return r=t,!0;o=o[e]}),void 0===r&&(r=o),r}function merge(){var e=arguments[0];return each(Array.prototype.slice.call(arguments).slice(1),function(n){each(n,function(n,t){n instanceof Object&&e[t]&&e[t]instanceof Object?e[t]=merge(e[t],n):e[t]=n})}),e}function getDefault(e){if(stringTypes.indexOf(e)>=0)return"";if(numberTypes.indexOf(e)>=0)return 0;switch(e){case"bool":return!1;case"google.protobuf.Timestamp":return new Date}throw new Error("Type "+e+" not recognized")}function toObjectType(e,n){if(stringTypes.indexOf(e)>=0)return String(n);if(numberTypes.indexOf(e)>=0)return parseFloat(n);switch(e){case"bool":return Boolean(n);case"google.protobuf.Timestamp":return new Date(n).getTime()}throw new Error("Type "+e+" not recognized")}function verify(e,n){if(stringTypes.indexOf(e)>=0)return"string"==typeof n;if(numberTypes.indexOf(e)>=0)return"number"==typeof n;switch(e){case"bool":return"boolean"==typeof n;case"google.protobuf.Timestamp":return n instanceof Date}throw new Error("Type "+e+" not recognized")}function messageProvider(e,n,t){function r(e){var n=this;each(o,function(t,r){null!==e[r]&&e.hasOwnProperty(r)&&(n[r]=e[r])})}var o={};return each(n,function(e){t.ignoreTypes.indexOf(e.typename)<0&&(o[e.name]=e.typename)}),r.type=e,each(o,function(e,n){r.prototype[n]=getDefault(e)}),r.create=function(e){return new r(e)},r.prototype.toObject=function(){var e=this,n={};return each(o,function(t,r){null!==e[r]&&e[r]!==getDefault(t)&&(n[r]=toObjectType(t,e[r]))}),n},r.verify=function(e){var n=!0;return each(o,function(t,r){if(!verify(t,e[r]))return n=!1,!0}),n},r}function sendRequest(e,n,t,r){var o=e;return"/"!==e[e.length-1]&&(o+="/"),o+=[n,t].join("/"),fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.toObject())}).then(checkStatus)}function checkStatus(e){if(e.status>=200&&e.status<300)return e;var n=new Error(e.statusText);throw n.response=e,n}function serviceProvider(e,n,t,r){var o={};o.__type=e;var i=e.split(".");return o.__name=i.pop(),o.__namespace=i.join("."),each(n,function(n){var i=t(getMessageName(n.param,o.__namespace)),a=t(getMessageName(n.returns,o.__namespace));o[n.name]=function(t){if(!i.verify(t))throw new Error("Invalid message in "+e+"."+n.name);return sendRequest(r,o.__name.toLowerCase(),n.name,t).then(function(t){var r=a.create(t);if(!a.verify(r))throw new Error("Invalid response in "+e+"."+n.name);return r})}}),o}function getMessageName(e,n){return e.indexOf(".")>=0?e:[n,e].join(".")}function protoProvider(e,n){var t={},r=merge(defaultOptions,n);return function n(o){if(t[o])return t[o];var i=get(e,o,null);if(null===i)throw new Error("Definition not found");return"message"===i.type?t[o]=messageProvider(o,i.content,r):t[o]=serviceProvider(o,i.content,n,r.server)}}require("whatwg-fetch");var stringTypes=["string","bytes"],numberTypes=["double","float","int32","int64","uint32","uint64","sint32","sint64","fixed32","sfixed32","sfixed64"],defaultOptions={ignoreTypes:[]};module.exports=protoProvider;

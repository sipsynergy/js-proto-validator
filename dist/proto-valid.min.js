"use strict";function each(e,n){return(Array.isArray(e)?eachArray:eachObj)(e,n)}function eachArray(e,n){for(var r=0;r<e.length&&!n(e[r],r);++r);return e}function eachObj(e,n){return eachArray(Object.keys(e),function(r){n(e[r],r)})}function get(e,n,r){var t,i=e;return each(n.split("."),function(e){if(void 0===i[e])return t=r,!0;i=i[e]}),void 0===t&&(t=i),t}function merge(){var e=arguments[0];return each(Array.prototype.slice.call(arguments).slice(1),function(n){each(n,function(n,r){n instanceof Object&&e[r]&&e[r]instanceof Object?e[r]=merge(e[r],n):e[r]=n})}),e}function getDefault(e){if(e.repeated||arrayTypes.indexOf(e)>=0)return[];if(stringTypes.indexOf(e)>=0)return"";if(numberTypes.indexOf(e)>=0)return 0;switch(e){case"bool":return!1;case"google.protobuf.Timestamp":return new Date}return null}function toObjectType(e,n,r,t){if(arrayTypes.indexOf(e)>=0)return toObjectType({typename:e,repeated:!0});if(e.repeated){var i=[];return n&&n instanceof Array&&each(n,function(n){i.push(toObjectType(e.typename,n,r,t))}),i}if(stringTypes.indexOf(e)>=0)return String(n);if(numberTypes.indexOf(e)>=0)return parseFloat(n);switch(e){case"bool":return Boolean(n);case"google.protobuf.Timestamp":return new Date(n).getTime()}var o=e;return e.indexOf(".")<0&&(o=[t,e].join(".")),r(o).toObject&&n.toObject?n.toObject():n}function verify(e,n,r,t){if(arrayTypes.indexOf(e)>=0)return verify({typename:e,repeated:!0});if(e.repeated){if(n&&n instanceof Array){var i=!0;return each(n,function(n){verify(e.typename,n,r,t)||(i=!1)}),i}return!1}if(stringTypes.indexOf(e)>=0)return"string"==typeof n;if(numberTypes.indexOf(e)>=0)return"number"==typeof n;switch(e){case"bool":return"boolean"==typeof n;case"google.protobuf.Timestamp":return n instanceof Date}var o=r([t,e].join("."));if(o.$verify)return o.$verify(n);throw new Error("Type "+e+" not recognized")}function messageProvider(e,n,r,t){function i(e){var n=this;each(o,function(r,t){null!==e[t]&&e.hasOwnProperty(t)&&(n[t]=e[t])})}var o={};each(n,function(e){t.ignoreTypes.indexOf(e.typename)<0&&(e.repeated?o[e.name]=e:o[e.name]=e.typename)}),i.__type=e;var a=e.split(".");return a.pop(),i.__namespace=a.join("."),each(o,function(e,n){i.prototype[n]=getDefault(e)}),i.create=function(e){return new i(e)},i.prototype.toObject=function(){var e=this,n={};return each(o,function(t,o){null!==e[o]&&e[o]!==getDefault(t)&&(n[o]=toObjectType(t,e[o],r,i.__namespace))}),n},i.$verify=function(e){var n=!0;return each(o,function(t,o){if(!verify(t,e[o],r,i.__namespace))return n=!1,!0}),n},i}function sendRequest(e,n,r,t){var i=e;return"/"!==e[e.length-1]&&(i+="/"),i+=n.concat(r).join("/"),fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.toObject())}).then(checkStatus)}function checkStatus(e){if(e.status>=200&&e.status<300)return e;var n=new Error(e.statusText);throw n.response=e,n}function serviceProvider(e,n,r,t){var i={};i.__type=e;var o=e.split(".");return i.__name=o.pop(),i.__namespace=o.join("."),each(n,function(n){var o=r(getMessageName(n.param,i.__namespace)),a=r(getMessageName(n.returns,i.__namespace));i[n.name]=function(r,u){var c=void 0!==u&&!u;if(c&&!o.$verify(r))throw new Error("Invalid message in "+e+"."+n.name);if(t.requestFn)return t.requestFn(i.__type,n.name,r,o,a);var f=i.__type.split(".");return f.shift(),sendRequest(t.server,f,n.name,r).then(function(r){var t=a.create(r);if(c&&!a.$verify(t))throw new Error("Invalid response in "+e+"."+n.name);return t})}}),i}function getMessageName(e,n){if(e.indexOf(".")>=0){var r=n.split("."),t=[e,[n,e].join(".")];return r.pop(),r.push(e),t.push(r.join(".")),t}return[n,e].join(".")}function enumProvider(e,n){var r={};return each(n,function(e){r[e.name]=e.val}),r.$verify=function(e){if(null===e)return!0;var n=!1;return each(r,function(r,t){e===r&&(n=!0)}),n},r}function protoProvider(e,n){var r={},t=merge(defaultOptions,n);return function n(i){if(i instanceof Array){var o=null;if(each(i,function(e){if(!o)try{o=n(e)}catch(e){}}),o)return o;throw new Error("Definition ["+i.join(", ")+"] not found")}if(r[i])return r[i];var a=get(e,i,null);if(null===a)throw new Error("Definition ["+i+"] not found");switch(a.type){case"message":return r[i]=messageProvider(i,a.content,n,t);case"service":return r[i]=serviceProvider(i,a.content,n,t);case"enum":return enumProvider(i,a.content)}throw new Error("Definition found but unrecognized")}}var arrayTypes=["bytes"],stringTypes=["string","bytes"],numberTypes=["double","float","int32","int64","uint32","uint64","sint32","sint64","fixed32","sfixed32","sfixed64"],defaultOptions={ignoreTypes:[]};module.exports=protoProvider;

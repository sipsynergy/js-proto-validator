"use strict";function each(e,n){return(Array.isArray(e)?eachArray:eachObj)(e,n)}function eachArray(e,n){for(var t=0;t<e.length&&!n(e[t],t);++t);return e}function eachObj(e,n){return eachArray(Object.keys(e),function(t){n(e[t],t)})}function get(e,n,t){var r,a=e;return each(n.split("."),function(e){if(void 0===a[e])return r=t,!0;a=a[e]}),void 0===r&&(r=a),r}function merge(){var e=arguments[0];return each(Array.prototype.slice.call(arguments).slice(1),function(n){each(n,function(n,t){n instanceof Object&&e[t]&&e[t]instanceof Object?e[t]=merge(e[t],n):e[t]=n})}),e}function getDefault(e){if(e.repeated||arrayTypes.indexOf(e.typename)>=0)return[];if(stringTypes.indexOf(e.typename)>=0)return"";if(numberTypes.indexOf(e.typename)>=0)return 0;switch(e.typename){case"bool":return!1;case"google.protobuf.Timestamp":return new Date}return null}function toObjectType(e,n,t,r){if(arrayTypes.indexOf(e.typename)>=0&&(e.repeated=!0,e.typename=arrayTypeMap[e.typename]),e.repeated){var a=[];return n&&n instanceof Array&&each(n,function(n){a.push(toObjectType({typename:e.typename},n,t,r))}),a}if(stringTypes.indexOf(e.typename)>=0)return String(n);if(numberTypes.indexOf(e.typename)>=0)return parseFloat(n);switch(e.typename){case"bool":return Boolean(n);case"google.protobuf.Timestamp":return new Date(n).getTime()}var i=e.typename;return e.typename.indexOf(".")<0&&(i=[r,e.typename].join(".")),t(i).toObject&&n.toObject?n.toObject():n}function verify(e,n,t,r){if(!e.required)return!0;if(arrayTypes.indexOf(e.typename)>=0&&(e.repeated=!0,e.typename=arrayTypeMap[e.typename]),e.repeated){if(n&&n instanceof Array){var a=!0;return each(n,function(n){verify(e,n,t,r)||(a=!1)}),a}return!1}if(stringTypes.indexOf(e.typename)>=0)return"string"==typeof n;if(numberTypes.indexOf(e.typename)>=0)return"number"==typeof n;switch(e.typename){case"bool":return"boolean"==typeof n;case"google.protobuf.Timestamp":return n instanceof Date}var i=t([r,e.typename].join("."));if(i.$verify)return i.$verify(n);throw new Error("Type "+e.typename+" not recognized")}function messageProvider(e,n,t,r){function a(e){var n=this;each(i,function(t,r){null!==e[r]&&e.hasOwnProperty(r)&&(n[r]=e[r])})}var i={};each(n,function(e){r.ignoreTypes.indexOf(e.typename)<0&&(i[e.name]=e)}),a.__type=e;var o=e.split(".");return o.pop(),a.__namespace=o.join("."),each(i,function(e,n){a.prototype[n]=getDefault(e)}),a.create=function(e){return new a(e)},a.prototype.toObject=function(){var e=this,n={};return each(i,function(r,i){null!==e[i]&&void 0!==e[i]&&e[i]!==getDefault(r)&&(n[i]=toObjectType(r,e[i],t,a.__namespace))}),n},a.$verify=function(e){var n=!0;return each(i,function(r,i){if(!verify(r,e[i],t,a.__namespace))return n=!1,!0}),n},a}function sendRequest(e,n,t,r){var a=e;return"/"!==e[e.length-1]&&(a+="/"),a+=n.concat(t).join("/"),fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.toObject())}).then(checkStatus)}function checkStatus(e){if(e.status>=200&&e.status<300)return e;var n=new Error(e.statusText);throw n.response=e,n}function serviceProvider(e,n,t,r){var a={};a.__type=e;var i=e.split(".");return a.__name=i.pop(),a.__namespace=i.join("."),each(n,function(n){var i=t(getMessageName(n.param,a.__namespace)),o=t(getMessageName(n.returns,a.__namespace));a[n.name]=function(t,u){var c=void 0!==u&&!u;if(c&&!i.$verify(t))throw new Error("Invalid message in "+e+"."+n.name);if(r.requestFn)return r.requestFn(a.__type,n.name,t,i,o);var s=a.__type.split(".");return s.shift(),sendRequest(r.server,s,n.name,t).then(function(t){var r=o.create(t);if(c&&!o.$verify(r))throw new Error("Invalid response in "+e+"."+n.name);return r})},a[n.name].__name=n.name}),a}function getMessageName(e,n){if(e.indexOf(".")>=0){var t=n.split("."),r=[e,[n,e].join(".")];return t.pop(),t.push(e),r.push(t.join(".")),r}return[n,e].join(".")}function enumProvider(e,n){var t={};return each(n,function(e){t[e.name]=e.val}),t.$verify=function(e){if(null===e)return!0;var n=!1;return each(t,function(t,r){e===t&&(n=!0)}),n},t}function protoProvider(e,n){var t={},r=merge(defaultOptions,n);return function n(a){if(a instanceof Array){var i=null;if(each(a,function(e){if(!i)try{i=n(e)}catch(e){}}),i)return i;throw new Error("Definition ["+a.join(", ")+"] not found")}if(t[a])return t[a];var o=get(e,a,null);if(null===o)throw new Error("Definition ["+a+"] not found");switch(o.type){case"message":return t[a]=messageProvider(a,o.content,n,r);case"service":return t[a]=serviceProvider(a,o.content,n,r);case"enum":return enumProvider(a,o.content)}throw new Error("Definition found but unrecognized")}}var arrayTypes=["bytes"],arrayTypeMap={bytes:"string"},stringTypes=["string","bytes"],numberTypes=["double","float","int32","int64","uint32","uint64","sint32","sint64","fixed32","sfixed32","sfixed64"],defaultOptions={ignoreTypes:[]};module.exports=protoProvider;
